<!DOCTYPE html>
<html>

<head lang="en">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<meta http-equiv="Pragma" content="no-cache">
	<!-- http 1.0 -->
	<meta http-equiv="Cache-Control" content="no-cache">
	<!-- http 1.1 -->
	<script src="js/laypage.js" type="text/javascript"></script>
	<script src="js/jquery.printArea.js" type="text/javascript"></script>
	<script src="js/xlsx.core.min.js" type="text/javascript"></script>
	<script src="js/Blob.js" type="text/javascript"></script>
	<script src="js/FileSaver.js" type="text/javascript"></script>
	<script src="js/tableexport.js" type="text/javascript"></script>
	<script src="js/inputLimit.js" type="text/javascript"></script>
	<style>
		#rtuMapArea,
		#tab,
		#mapfrm {
			width: 100%;
			height: 100%;
			overflow: hidden;
			margin: 0;
			font-family: "微软雅黑";
		}
		
		#menu {
			height: 100%;
			overflow-y: auto
		}
		
		td {
			font-size: 14px
		}
		
		h4 {
			margin: 0;
		}
		
		.btn-toolbar.top {
			padding: 1px;
		}
		
		.btn.btn-default {
			width: 100px;
			padding: 1px;
		}
		
		.btn.btn-default.xlsx {
			margin-left: 500px;
		}
		
		#printBtn,
		#exportBtn {
			cursor: pointer;
		}
		
		.mapDiv {
			width: 83%;
			float: right;
		}
		
		#controlMapArea {
			margin-top: 0px;
			width: 100%;
			height: 100%;
			float: right;
			overflow: hidden;
			font-family: "微软雅黑";
		}
	</style>
</head>

<body>
	<div class="RTUContent">
		<div class="leftTreeCont">
			<div class="leftTree" id="leftTree">
			</div>
		</div>
		<div class="mapDiv" style="height:680px;margin-top:20px;">
			<div id="controlMapArea">
				<iframe width="98.5%" height="100%" src="html/system/systemMap.html"></iframe>
			</div>
		</div>
		<div class="rightTable" style="display:none">
			<div class="RTUTable tableSet">
				<div class="tableSearch">
					<span id="backToGis">回到GIS</span>
					<span>RTU名称</span>
					<input id="RtuNameSearch" type="text" />
					<span onclick="searchRtu()" class="spanbutton">查询</span>
					<span class="spanbutton RTUAdd">新增RTU</span>
					<span class="spanbutton RTUModify">修改RTU</span>
					<span class="spanbutton RTUDelete">删除RTU</span>
					<span class="spanbutton RTUView">查看RTU</span>
					<span  id="printBtn" class="spanbutton">打印</span>
					<span id="exportBtn" class="spanbutton">导出</span>
				</div>
				<div class="printArea">
					<table class="table table-bordered RTUTableDetail tableDetail" style="cursor:default" id="RTUTableDetail">
						<thead>
							<tr>
								<th width="4%">序号</th>
								<th width="5%">RTU标识</th>
								<th width="8%">RTU名称</th>
								<th width="8%">RTU类型</th>
								<th width="8%">告警方式</th>
								<th width="8%">RTU地址</th>
								<th width="6%">机架序号</th>
								<th width="6%">局站标识</th>
								<th width="8%">局站名称</th>
								<th width="8%">RTU描述</th>
								<th width="8%">创建时间</th>
								<th width="8%">创建用户</th>
								<th width="8%">修改时间</th>
								<th width="8%">修改用户</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
						</tbody>

					</table>
				</div>
				<div id="pageon"></div>
			</div>
		</div>
	</div>
	<script>

$(document).ready(function() {
    $("#printBtn").click(function() {
        $(".printArea").printArea();
    });
    $("#exportBtn").click(function() {
        if($(".btn-toolbar.top")) {
            $(".btn-toolbar.top").remove();
        }                
        $("table").tableExport({
            headings: true,                     
            // (Boolean), display table headings (th/td elements) in the <thead>
            footers: true,                      
            // (Boolean), display table footers (th/td elements) in the <tfoot>
            formats: ["xlsx", "xls"],     
            // (String[]), filetype(s) for the export
            fileName: "id",                     
            // (id, String), filename for the downloaded file
            bootstrap: true,                    
            // (Boolean), style buttons using bootstrap
            position: "top",                 
            // (top, bottom), position of the caption element relative to table
        });
        $(".btn.btn-default.xlsx").bind("click",function() {
            $(".btn-toolbar.top").remove();           
        });
        $(".btn.btn-default.xls").bind("click",function() {
            $(".btn-toolbar.top").remove();
        });
    });
});
</script>
	<script type="text/javascript">
                tree = new dTree('tree');//创建一个对象.
                tree.config.folderLinks=true;
                tree.config.useCookies=false;
                tree.config.check=true;
                $.ajax({
                    url:'create_tree',
                    type:'post', //数据发送方式
                    dataType:'json', //接受数据格式
                    async: false,
                    success: function(json){
                        $(json).each(function(){
                        	for(var count=0;count<json.length;count++){
                        		var stationId=" ";//定义字符串来承接areaId
                        		 var nodeId=json[count].id;//读取节点id
                                 var parentId=json[count].pid;//读取节点pid             
                                 var hrefAddress="";//定义url指向js，当为区域时需要使用
                                 if(parseInt(json[count].id[0])<3){//最多只到局站
                              	 if(parseInt(json[count].id[0])==2){//为局站
                              		 var stationName=json[count].name;
                              		for(var index=2;index<json[count].id.length;index++){ //读取areaId，    id新式为x_xxx,所以从第二位开始为areaId
                              			stationId+=json[count].id[index];//拼接字符串，获得字符串形式的areaId
                              		 }
                              		hrefAddress="javascript:selectRtuByStation('"+parseInt(stationId)+"','"+stationName+"')";
                              	   }
                              	if(parseInt(json[count].id[0])==0){//为根节点
                              		stationId="0";
                              		hrefAddress="javascript:reloadCurentpage()";//为区域，添加点击事件，function()入口参数为areaId
                              		json[count].name="RTU管理";
                              	   }
                                	var nodeName=json[count].name;
                            
                            tree.add(nodeId,parentId,nodeName,hrefAddress,"","","","",false);
                                 }
                        	}
                        });
                    }
                });
                document.getElementById("leftTree").innerHTML = tree;


 /**表格范围内禁止系统右键，使用自定义右键**/
    $("#RTUTableDetail").hover(function(){
    	 $(document).bind("contextmenu",function(e){   
    		   return false;   
    		 });
    },
    function(){
    	$(document).unbind("contextmenu","")
    });	
    /****************************添加右键菜单功能***********************************/
    $(".RTUTableDetail tbody tr").click(function(){
    	 $(this).addClass("currtr").siblings().removeClass("currtr");
    	 var selectId="";
    	
    	 if(this.children[1].innerHTML!=""){
    		 selectId=this.children[1].innerHTML;
    		 $(this).addClass("rtu").siblings().removeClass("rtu");
    	 }
    	 else{//不存在条目
    		 $(this).removeClass("rtu").siblings().removeClass("rtu");
    	 }
    	       
    	var menu = new BootstrapMenu('.rtu', {
                actions: [{
                    name: '查看RTU',
                    onClick: function() {
                    	$(this).remove();
                    	 $(".sidebarDiv").load("html/resource/RTUView.html");                    	
                    }
                },
                {
                    name: '修改RTU',
                    onClick: function() {
                    	$(menu).remove();
                    	$(".sidebarDiv").load("html/resource/RTUModify.html");
                    }
                },
                {
                    name: '删除RTU',
                    onClick: function() {
                    	$(this).remove();
                    	if(selectId!=""){
                    		var txt="警告：删除RTU将删除该RTU下的所有资源,";
                        	txt+="请谨慎选择!!"
                        	txt+="确认继续请点击\"确定\"键";
                			var option={
                	   					title: "提示",
                	   					btn: parseInt("0001",2),
                	   					onOk: function(){//点击确认的执行方法
                	   						delRtu(selectId);
                	   					}
                	   				}
                	   		window.wxc.xcConfirm(txt, "info", option);
                    	}
                   }
                }]
            });
    }) 
    

</script>

	<!-- 表格部分页面的操作功能 -->
	<script>
/************************实现分页的表格写入函数***************************/
            function tableDataIn(tabledata){
                var tableData = tabledata;/*tableData为后台需渲染到表格中的所有数据*/
                var nums = document.querySelectorAll(".RTUTableDetail tbody tr").length;
                var cells = document.getElementById("RTUTableDetail").rows.item(0).cells.length;
                var pages = Math.ceil(tableData.length/nums);
                var thisData = function (curr) {
                    var tableDataCurr= [];
                    var last = curr*nums - 1;
                    last = last >= tableData.length ? (tableData.length - 1) : last;
                    tableDataCurr = tableData.slice(curr*nums - nums,last + 1);
                    return tableDataCurr;
                };
                
                laypage({
                    cont: 'pageon',
                    pages: pages,
                    jump: function(obj) {
                        var currTableData = thisData(obj.curr);
                        var trs = document.querySelectorAll("#RTUTableDetail tbody tr");
                        var tds = document.querySelectorAll("#RTUTableDetail tbody tr td");
                        for (var i=0;i<tds.length;i++){
                            tds[i].innerHTML = "";
                        }                        
                        for (var i = 0; i < currTableData.length; i++) {
                            var Ele = trs[i].children;
                            for(var j=0; j<cells-1; j++){
                                Ele[0].innerHTML = i + 1;
                                Ele[j+1].innerHTML = currTableData[i][j];
                            }
                        }
                    }
                });
            }
/************************叶节点执行的查询数据库并写入table的操作*************************/  
var dataSearch=[];
var ifClickStation="0";
function selectRtuByStation(stationID,stationName){
			 $(".rightTable").css("display","block");
			 $(".mapDiv").css("display","none");
			 ifClickStation="1";
	         addUnderStationId=stationID;
	         addUnderStationName=stationName;
           	 var dataInput=[];            	    
              	$.ajax({
                      			type : "post",
                      			async : false,  //异步请求 先执行后续操作，再执行sucess
                      			url : "ResourceListRtu",
                      			dataType:"json",
                      			data : {"stationID":stationID},
                      			success:function(data){
                      				dataSearch=data;
                      				if(data[0].status)
                      					{
                      					for(i=1;i<data.length;i++){
                             				dataInput.push([
                             				                data[i].rtuId,
                               				                data[i].rtuName,
                               				                data[i].type,
                               				    			data[i].alarmWay,
	                           							    data[i].rtuUrl,
	                           							    data[i].tackOrder,
                               							    data[i].stationId,
                               							    data[i].stationName,
                               							    data[i].description,
                               							 	data[i].createDate,
                               								data[i].createUser,
                               								data[i].alterDate,
                               								data[i].alterUser,
                               							    ]);  
                             				}
                      					}
                      				tableDataIn(dataInput);
                      			},                      		
                          	});
}       

/**********************根据RTU名字查询RTU***********************/              	
           function searchRtu(){
	           var RtuNAME=document.getElementById("RtuNameSearch").value;
               if(RtuNAME!=""){
              		$.ajax({
		              	      type : "post",
		              	      async : false,  //异步请求 先执行后续操作，再执行sucess
		              	      url : "ResourceSearchRTUAll",
		              	      dataType:"json",
		              	      data : {'RtuNAME':RtuNAME},
		              	      success:function(data){
		              	            if(data.length==0) {
		              	            	    var rtuPara=[];
		              	            	    tableDataIn(rtuPara);
			              	            	var txt="找不到符合条件的RTU，请核对后重新搜索<br/>";
			                          	    var option={
			                        	   				  title: "提示",
			                        	   				  btn: parseInt("0001",2),
			                        	   				  onOk: function(){//点击确认的执行方法			                        	   					 
			                        	  			       }
			                        	   	}
			                        	   	window.wxc.xcConfirm(txt, "info", option);
		              	            } 
		              	            else{
		              	            		var dataINPUT=[];
		              	            		for(i=0;i<data.length;i++){
			              	            		dataINPUT.push([ 
			              	            		                    data[i].rtuId,
		                               				                data[i].rtuName,
		                               				                data[i].type,
		                               				    			data[i].alarmWay,
			                           							    data[i].rtuUrl,
			                           							    data[i].tackOrder,
		                               							    data[i].stationId,
		                               							    data[i].stationName,
		                               							    data[i].description,
		                               							 	data[i].createDate,
		                               								data[i].createUser,
		                               								data[i].alterDate,
		                               								data[i].alterUser,
		                           							    ]);  
		                         			}
		              	            		tableDataIn(dataINPUT);		              	            		
		              	            	} 
		              	              },		              	      
		              	});
                 }
            } 

   $(".RTUAdd").click(function () {
    	if(ifClickStation=="0")
        	{
        	  var txt="请先选择进入一个局站";
			  var option={
	   					title: "提示",
	   					btn: parseInt("0001",2),
	   					onOk: function(){//点击确认的执行方法
	   					}
	   				}
	   		window.wxc.xcConfirm(txt, "info", option);
        	}
        else
        	$(".sidebarDiv").load("html/resource/RTUAdd.html");
    });

    $(".RTUModify").click(function () {
    	var trs = document.querySelectorAll("#RTUTableDetail tbody tr");
        var selectId="";
        for (var i=0;i<trs.length;i++){
            if($(trs[i]).hasClass("currtr")){
            	selectId = trs[i].children[0].innerHTML;
            	i=trs.length;
            }
        }
        if(selectId==""){
        	var txt="清先选择您要修改的RTU";
			var option={
	   					title: "提示",
	   					btn: parseInt("0001",2),
	   					onOk: function(){//点击确认的执行方法
	   					}
	   				}
	   		window.wxc.xcConfirm(txt, "info", option);
        }
        else{	
		        
		      $(".sidebarDiv").load("html/resource/RTUModify.html");
        }
    });

     $(".RTUDelete").click(function () {
    	var trs = document.querySelectorAll("#RTUTableDetail tbody tr");
    	var rtuId="";
        for (var i=0;i<trs.length;i++){
            if($(trs[i]).hasClass("currtr")){
            	rtuId = trs[i].children[1].innerHTML;
            	i=trs.length;
            }
        }
        if(rtuId==""){
        	var txt="请先选择您要删除的RTU";
			var option={
	   					title: "提示",
	   					btn: parseInt("0001",2),
	   					onOk: function(){//点击确认的执行方法
	   					}
	   				}
	   		window.wxc.xcConfirm(txt, "info", option);
        }
        else{
        	var txt="警告：删除RTU将删除该RTU下的所有资源<br/>";
        	txt+="请谨慎选择!!<br/>"
        	txt+="确认继续请点击确定键";
			var option={
	   					title: "提示",
	   					btn: parseInt("0001",2),
	   					onOk: function(){//点击确认的执行方法
	   						delRtu(rtuId);
	   					}
	   				}
	   		window.wxc.xcConfirm(txt, "info", option);
        }
    }); 
/**
 *删除rtu 
 **/
 function delRtu(rtuId){
	 $.ajax({
			type : "post",
			async : false,  //异步请求 先执行后续操作，再执行sucess
			url : "rtu/delRtu",
			dataType:"json",
			data : {"rtuId":rtuId},
			success: function(json){
       	        var txt="";
		    	if(json[0].status){
		    		txt+="删除成功<br/>"
		    	}
		    	else{
		    		txt+="删除失败，请重试<br/>";
		    		txt+="错误原因："+json[0].err;
		    	}
			     var option = {
							title: "提示",
							btn: parseInt("0001",2),
							onOk: function(){//点击确认的执行方法								
							}
						}
				  window.wxc.xcConfirm(txt, "info", option);
		      },
		    error:function(XMLHttpRequest,Error)
		      {
		    	    var txt="删除失败<br/>";
		    	    txt+="失败原因：";
		    	    if(XMLHttpRequest.status==401){
		    	        txt+="您不具有当前操作的权限<br/>";
		    	     }
		    	     else{
		    	        	txt+="网络错误<br/>";
		    	        	txt+="状态码："+XMLHttpRequest.status;
		    	        }
		    	      var option={
		    	   					title: "提示",
		    	   					btn: parseInt("0001",2),
		    	   					onOk: function(){//点击确认的执行方法		    	   						
		    	  			       }
		    	   				}
		    	   window.wxc.xcConfirm(txt, "info", option);
		  }
	 });
	 var trs = document.querySelectorAll("#RTUTableDetail tbody tr");
     var stationId="";
     var stationName="";
     for (var i=0;i<trs.length;i++){
         if($(trs[i]).hasClass("currtr")){
        	  stationId=trs[i].children[7].innerHTML;
        	  stationName=trs[i].children[8].innerHTML;
        	  i=trs.length;
         }
     }
	 selectRtuByStation(stationId,stationName);
  }
  
  $(".RTUView").click(function(){
	  var trs = document.querySelectorAll("#RTUTableDetail tbody tr");
	  var selectId="";
      for (var i=0;i<trs.length;i++){
          if($(trs[i]).hasClass("currtr")){
        	 selectId = trs[i].children[1].innerHTML;
          	 i=trs.length;
          }
      }
      if(selectId==""){
      	var txt="清先选择您要查看的RTU";
			var option={
	   					title: "提示",
	   					btn: parseInt("0001",2),
	   					onOk: function(){//点击确认的执行方法
	   					}
	   				}
	   		window.wxc.xcConfirm(txt, "info", option);
      }
      else{	
		       
		        $(".sidebarDiv").load("html/resource/RTUView.html");
      }
  })
   
 function reloadCurentpage(){
	$(".containerDiv").load("html/resource/RTU.html");
 }
//载入这个页面的时候，首先呈现的是GIS界面
  $(".rightTable").css("display","none");
  $(".mapDiv").css("display","block");

  $("#backToGis").click(function(){
  	$(".rightTable").css("display","none");
  	$(".mapDiv").css("display","block");
  })
function openSpeficTree(stationId){
	tree.config.folderLinks=false;
	tree.closeAll();
	$(".rightTable").css("display","block");
  	$(".mapDiv").css("display","none");
	var stationid="2_"+stationId;
	tree.openTo(stationid,true);
}
</script>
</body>

</html>